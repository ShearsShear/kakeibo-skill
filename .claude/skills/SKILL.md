# kakeibo

生活費の予算管理スキル。支出の記録・分析と予算超過の判定を行う。

## トリガーワード

- `/kakeibo`
- 「家計簿」
- 「支出を記録」
- 「予算確認」

## データ保存先

```
./kakeibo/
├── expenses.csv      # 支出データ
├── budgets.csv       # 予算設定
├── categories.csv    # カテゴリ設定
└── overages.csv      # 超過理由の記録
```

## CSVファイル形式

### expenses.csv（支出記録）
```csv
date,category,amount,memo,cycle
2024-02-11,楽天カード,432410,2月時点の累計,2024-01
2024-02-11,PayPay,16849,2月時点の累計,2024-02
```

**cycle（サイクル）:**
- 締め日に基づく請求サイクルを `YYYY-MM` 形式で記録
- 例: 楽天カード（12日締め）で2/11の支出 → cycle は `2024-01`（1/13〜2/12のサイクル）
- 例: PayPay（末日締め）で2/11の支出 → cycle は `2024-02`（2/1〜2/29のサイクル）

### budgets.csv（月額予算設定）
```csv
category,monthly_budget
食費,30000
交通費,10000
```

### categories.csv（カスタムカテゴリ＋締め日）
```csv
category,description,closing_day
楽天カード,楽天カードでの支払い,12
PayPay,PayPayでの支払い,末日
高島屋カード,高島屋カードでの支払い,10
```

**closing_day（締め日）の値:**
- 数字（1〜28）: その日が締め日
- 「末日」: 月末締め

### overages.csv（超過理由の記録）
```csv
date,category,budget,actual,overage_amount,reason,action_plan,cycle
2024-02-11,楽天カード,300000,432410,132410,季節要因,支出を抑える,2024-01
```

**cycle:** どのサイクルの超過かを記録

## 実行手順

### ステップ1: 操作の確認

AskUserQuestionツールで操作を確認:

```
質問: 何をしますか？
オプション:
- 支出を記録 - 新しい支出を追加する
- 予算状況を確認 - 今月の予算消化率を確認する
- カテゴリを管理 - カテゴリの追加・編集
- 予算を設定 - 月額予算を設定・変更する
```

### ステップ2: 各操作の処理

#### 支出を記録する場合

1. ユーザーからテキスト入力を受け取る
   - 例: 「食費 1500円 スーパー」「交通費 350」

2. テキストを解析して以下を抽出:
   - カテゴリ名
   - 金額（円、¥、数字のみ対応）
   - メモ（オプション）

3. カテゴリが存在しない場合はAskUserQuestionで確認:
   ```
   質問: 「〇〇」は新しいカテゴリです。追加しますか？
   オプション:
   - 新規追加する - カテゴリを登録して記録
   - 既存から選ぶ - 既存カテゴリを表示して選択
   - キャンセル - 記録をキャンセル
   ```

4. expenses.csvに追記

5. 記録後、自動で予算状況をチェック

#### 予算状況を確認する場合

1. **締め日サイクルの判定:**
   - 各カテゴリの締め日（closing_day）を確認
   - 現在日付がどのサイクルに属するかを判定

   **サイクル判定ルール:**
   - 締め日が12日の場合:
     - 2/1〜2/12 → 1月サイクル（1/13〜2/12）
     - 2/13〜2/28 → 2月サイクル（2/13〜3/12）
   - 末日締めの場合:
     - 2/1〜2/29 → 2月サイクル（2/1〜2/29）

2. expenses.csvから**該当サイクル**の支出を集計
3. budgets.csvの予算と比較
4. 以下の形式で出力:

```
## 今月の予算状況（2024年2月）

| カテゴリ | 予算 | 支出 | 残り | 消化率 | 状態 |
|---------|------|------|------|--------|------|
| 食費 | ¥30,000 | ¥15,000 | ¥15,000 | 50% | OK |
| 交通費 | ¥10,000 | ¥12,000 | -¥2,000 | 120% | 超過 |

### 警告
- 交通費が予算を ¥2,000 超過しています

### 全体
- 総予算: ¥100,000
- 総支出: ¥45,000
- 消化率: 45%
```

4. 予算超過時の警告表示:
   - 80%以上: 注意（黄色警告）
   - 100%以上: 超過（赤警告）

5. **超過時の理由ヒアリング（100%以上の場合）**:

   超過しているカテゴリごとにAskUserQuestionで理由を確認:
   ```
   質問: 「〇〇」が予算を¥XX超過しています。理由は何ですか？
   オプション:
   - 想定外の出費 - 予期せぬ支出があった
   - 見積もり不足 - 予算設定が低すぎた
   - 季節要因 - 時期的に出費が増えた
   - やむを得ない支出 - 必要な支出だった
   ```

   その後、改善策をヒアリング:
   ```
   質問: 来月に向けてどうしますか？
   オプション:
   - 予算を増額する - 現実的な金額に見直す
   - 支出を抑える - 節約を心がける
   - 現状維持 - 特に対策は取らない
   - 詳細を記録 - 具体的な改善策をメモする
   ```

6. overages.csvに超過記録を保存:
   - 日付、カテゴリ、予算額、実績額、超過額
   - ヒアリングした理由と改善策

#### カテゴリを管理する場合

1. AskUserQuestionで操作を確認:
   ```
   質問: カテゴリ操作を選んでください
   オプション:
   - 一覧表示 - 現在のカテゴリ一覧
   - 追加 - 新しいカテゴリを追加
   - 編集 - カテゴリ名・説明を変更
   - 削除 - カテゴリを削除
   ```

2. 選択に応じてcategories.csvを操作

#### 予算を設定する場合

1. 現在の予算設定を表示
2. AskUserQuestionで設定方法を確認:
   ```
   質問: どのカテゴリの予算を設定しますか？
   オプション:
   - 個別設定 - 1つのカテゴリを設定
   - 一括設定 - 全カテゴリをまとめて設定
   - 新規カテゴリ追加 - 予算付きで新カテゴリを追加
   ```

3. budgets.csvを更新

### ステップ3: 初回セットアップ

ディレクトリやファイルが存在しない場合:

1. kakeibo ディレクトリを作成
2. 空のCSVファイルをヘッダー付きで作成
3. AskUserQuestionでデフォルトカテゴリを確認:
   ```
   質問: 初期カテゴリを設定しますか？
   オプション:
   - 基本カテゴリ - 食費、住居費、光熱費、交通費、通信費
   - 詳細カテゴリ - 基本＋娯楽、医療、教育、衣服、貯蓄
   - 決済方法別 - クレジットカード、電子マネー等
   - 空でスタート - カテゴリなしで開始
   ```

## テキスト入力パターン

以下のパターンを認識する:

```
食費 1500円              → カテゴリ:食費, 金額:1500
交通費 ¥350 電車         → カテゴリ:交通費, 金額:350, メモ:電車
1000 娯楽 映画           → カテゴリ:娯楽, 金額:1000, メモ:映画
ランチ代 800             → カテゴリ:不明(確認), 金額:800, メモ:ランチ代
```

## 注意事項

- 金額は必須、カテゴリとメモはオプション
- カテゴリが不明な場合はユーザーに確認する
- **月の区切りはカテゴリごとの締め日に基づく**
- 支出登録時は自動で該当サイクルを判定してcycleに記録
- CSVファイルはUTF-8で保存

## 締め日サイクルについて

カード会社や決済サービスごとに締め日が異なる場合、各カテゴリに締め日を設定することで正確な予算管理ができます。

**サイクル例（12日締めの場合）:**

| 月 | サイクル期間 |
|----|-------------|
| 1月 | 12/13〜1/12 |
| 2月 | 1/13〜2/12 |
| 3月 | 2/13〜3/12 |
